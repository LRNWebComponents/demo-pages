<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-pages/iron-pages.html">
<link rel="import" href="../paper-menu-button/paper-menu-button.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../app-route/app-location.html">
<link rel="import" href="../paper-button/paper-button.html">

<!--
`demo-pages`
A LRN element

@demo demo/index.html
-->

<dom-module id="demo-pages">
  <template>
    <style>
      :host {
        display: block;
      }

      #navigation {
        display: flex;
        align-items: center;
        justify-content: flex-start;
      }

      #demo-label {
        display: inline;
        display: inline-flex;
      }
    </style>

    <app-location route="{{__route}}"></app-location>
    <app-route id="route" route="{{__route}}" pattern=":page">
    </app-route>

    <paper-menu-button no-animations>
      <div slot="dropdown-trigger">
        <div id="demo-label">Demo</div>
        <paper-button raised>[[selected]] <iron-icon icon="icons:expand-more"></iron-icon></paper-button>
      </div>
      <paper-listbox slot="dropdown-content">
        <template is="dom-repeat" items="[[__navigation]]">
          <paper-item data-index$="[[item]]" on-click="__updateActiveSection">[[item]]</paper-item>
        </template>
      </paper-listbox>
    </paper-menu-button>


    <iron-pages selected="{{selected}}" attr-for-selected="data-demo">
      <slot id="slot"></slot>
    </iron-pages>

  </template>

  <script>
    Polymer({

      is: 'demo-pages',

      properties: {
        /**
         * Should there be navigation
         */
        navigation: {
          type: Boolean,
          value: false,
        },
        /**
         * The currently selected item
         */
        selected: {
          type: String,
          notify: true,
        },
        __route: {
          type: Object,
        },
        __navigation: {
          type: Array,
          value: []
        },
      },

      observers: [
        '__routeChanged(__route)'
      ],

      ready: function () {
        const allChildren = Polymer.dom(this.$.slot).getDistributedNodes();
        // get all children
        const children = allChildren.filter((i) => i.nodeName === 'SECTION');
        // convert to navigation
        const navigation = children.map(i => i.getAttribute('data-demo') || i.innerText);
        // if there ar nav elements
        if (navigation) {
          this.set('__navigation', []);
          this.set('__navigation', navigation);

          if (!window.location.hash) {
            this.set('selected', navigation[0]);
          }
        }

        window.addEventListener('hashchange', (e) => {
          console.log(e);
        });
      },

      /**
       * Trigger selected state change.  We are going to use
       * the window hash since that's what iron-component-pages
       * uses.
       */
      updateSelected: function (selected) {
        // get the url hash that contains what element is selected
        window.location.hash = selected;
        // set the route.path to trigger an update, letting the rest
        // of our application know that the route has changed. It's
        // a hack because route doesn't inherintly work with hash
        // changes.
        this.set('__route.path', window.location.pathname);
      },

      /**
       * When a user clicks the section button update
       * the url.  The url will then trigger the state
       * change.
       */
      __updateActiveSection: function (e) {
        const index = e.target.getAttribute('data-index');
        this.updateSelected(index);
      },

      /**
       * Tie Route to selected state
       *
       * When the route changed look for the selected
       * attribute and update the internal selected state
       */
      __routeChanged: function (route) {
        let hash = window.location.hash;
        if (hash) {
          hash = hash.replace('\#', '');
          this.selected = hash;
        }
      },

    });
  </script>
</dom-module>